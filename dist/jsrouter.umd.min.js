!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.jsrouter=e()}(this,function(){"use strict";var t=Object.create;function e(){var e=t(null);return e.__=void 0,delete e.__,e}var n=function(t,e,n){this.path=t,this.matcher=e,this.delegate=n};n.prototype.to=function(t,e){var n=this.delegate;if(n&&n.willAddRoute&&(t=n.willAddRoute(this.matcher.target,t)),this.matcher.add(this.path,t),e){if(0===e.length)throw new Error("You must have an argument in the function passed to `to`");this.matcher.addChild(this.path,t,e,this.delegate)}};var r=function(t){this.routes=e(),this.children=e(),this.target=t};r.prototype.add=function(t,e){this.routes[t]=e},r.prototype.addChild=function(t,e,n,o){var i=new r(e);this.children[t]=i;var h=a(t,i,o);o&&o.contextEntered&&o.contextEntered(e,h),n(h)};function a(t,e,r){return function(o,i){var h=t+o;if(!i)return new n(h,e,r);i(a(h,e,r))}}function o(t,e,n){for(var r=0,a=0;a<t.length;a++)r+=t[a].path.length;var o={path:e=e.substr(r),handler:n};t.push(o)}function i(t,e,n,r){for(var a=e.routes,h=Object.keys(a),s=0;s<h.length;s++){var u=h[s],c=t.slice();o(c,u,a[u]);var l=e.children[u];l?i(c,l,n,r):n.call(r,c)}}function h(t){return t.split("/").map(u).join("/")}var s=/%|\//g;function u(t){return t.length<3||-1===t.indexOf("%")?t:decodeURIComponent(t).replace(s,encodeURIComponent)}var c=/%(?:2(?:4|6|B|C)|3(?:B|D|A)|40)/g;function l(t){return encodeURIComponent(t).replace(c,decodeURIComponent)}var d=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g,f=Array.isArray,p=Object.prototype.hasOwnProperty;function v(t,e){if("object"!=typeof t||null===t)throw new Error("You must pass an object as the second argument to `generate`.");if(!p.call(t,e))throw new Error("You must provide param `"+e+"` to `generate`.");var n=t[e],r="string"==typeof n?n:""+n;if(0===r.length)throw new Error("You must provide a param `"+e+"`.");return r}var g=[];g[0]=function(t,e){for(var n=e,r=t.value,a=0;a<r.length;a++){var o=r.charCodeAt(a);n=n.put(o,!1,!1)}return n},g[1]=function(t,e){return e.put(47,!0,!0)},g[2]=function(t,e){return e.put(-1,!1,!0)},g[4]=function(t,e){return e};var y=[];y[0]=function(t){return t.value.replace(d,"\\$1")},y[1]=function(){return"([^/]+)"},y[2]=function(){return"(.+)"},y[4]=function(){return""};var m=[];m[0]=function(t){return t.value},m[1]=function(t,e){var n=v(e,t.value);return O.ENCODE_AND_DECODE_PATH_SEGMENTS?l(n):n},m[2]=function(t,e){return v(e,t.value)},m[4]=function(){return""};var w=Object.freeze({}),E=Object.freeze([]);function S(t,e,n){e.length>0&&47===e.charCodeAt(0)&&(e=e.substr(1));for(var r=e.split("/"),a=void 0,o=void 0,i=0;i<r.length;i++){var h=r[i],s=0,c=0;12&(s=2<<(c=""===h?4:58===h.charCodeAt(0)?1:42===h.charCodeAt(0)?2:0))&&(h=h.slice(1),(a=a||[]).push(h),(o=o||[]).push(0!=(4&s))),14&s&&n[c]++,t.push({type:c,value:u(h)})}return{names:a||E,shouldDecodes:o||E}}function C(t,e,n){return t.char===e&&t.negate===n}var b=function(t,e,n,r,a){this.states=t,this.id=e,this.char=n,this.negate=r,this.nextStates=a?e:null,this.pattern="",this._regex=void 0,this.handlers=void 0,this.types=void 0};b.prototype.regex=function(){return this._regex||(this._regex=new RegExp(this.pattern)),this._regex},b.prototype.get=function(t,e){var n=this.nextStates;if(null!==n)if(f(n))for(var r=0;r<n.length;r++){var a=this.states[n[r]];if(C(a,t,e))return a}else{var o=this.states[n];if(C(o,t,e))return o}},b.prototype.put=function(t,e,n){var r;if(r=this.get(t,e))return r;var a=this.states;return r=new b(a,a.length,t,e,n),a[a.length]=r,null==this.nextStates?this.nextStates=r.id:f(this.nextStates)?this.nextStates.push(r.id):this.nextStates=[this.nextStates,r.id],r},b.prototype.match=function(t){var e=this.nextStates;if(!e)return[];var n=[];if(f(e))for(var r=0;r<e.length;r++){var a=this.states[e[r]];A(a,t)&&n.push(a)}else{var o=this.states[e];A(o,t)&&n.push(o)}return n};function A(t,e){return t.negate?t.char!==e&&-1!==t.char:t.char===e||-1===t.char}function R(t,e){for(var n=[],r=0,a=t.length;r<a;r++){var o=t[r];n=n.concat(o.match(e))}return n}var x=function(t){this.length=0,this.queryParams=t||{}};x.prototype.splice=Array.prototype.splice,x.prototype.slice=Array.prototype.slice,x.prototype.push=Array.prototype.push;function P(t){t=t.replace(/\+/gm,"%20");var e;try{e=decodeURIComponent(t)}catch(t){e=""}return e}var O=function(){this.names=e();var t=[],n=new b(t,0,-1,!0,!1);t[0]=n,this.states=t,this.rootState=n};O.prototype.add=function(t,e){for(var n=this.rootState,r="^",a=[0,0,0],o=new Array(t.length),i=[],h=!0,s=0,u=0;u<t.length;u++){for(var c=t[u],l=S(i,c.path,a),d=l.names,f=l.shouldDecodes;s<i.length;s++){var p=i[s];4!==p.type&&(h=!1,n=n.put(47,!1,!1),r+="/",n=g[p.type](p,n),r+=y[p.type](p))}o[u]={handler:c.handler,names:d,shouldDecodes:f}}h&&(n=n.put(47,!1,!1),r+="/"),n.handlers=o,n.pattern=r+"$",n.types=a;var v;"object"==typeof e&&null!==e&&e.as&&(v=e.as),v&&(this.names[v]={segments:i,handlers:o})},O.prototype.handlersFor=function(t){var e=this.names[t];if(!e)throw new Error("There is no route named "+t);for(var n=new Array(e.handlers.length),r=0;r<e.handlers.length;r++){var a=e.handlers[r];n[r]=a}return n},O.prototype.hasRoute=function(t){return!!this.names[t]},O.prototype.generate=function(t,e){var n=this.names[t],r="";if(!n)throw new Error("There is no route named "+t);for(var a=n.segments,o=0;o<a.length;o++){var i=a[o];4!==i.type&&(r+="/",r+=m[i.type](i,e))}return"/"!==r.charAt(0)&&(r="/"+r),e&&e.queryParams&&(r+=this.generateQueryString(e.queryParams)),r},O.prototype.generateQueryString=function(t){var e=[],n=Object.keys(t);n.sort();for(var r=0;r<n.length;r++){var a=n[r],o=t[a];if(null!=o){var i=encodeURIComponent(a);if(f(o))for(var h=0;h<o.length;h++){var s=a+"[]="+encodeURIComponent(o[h]);e.push(s)}else i+="="+encodeURIComponent(o),e.push(i)}}return 0===e.length?"":"?"+e.join("&")},O.prototype.parseQueryString=function(t){for(var e=t.split("&"),n={},r=0;r<e.length;r++){var a=e[r].split("="),o=P(a[0]),i=o.length,h=!1,s=void 0;1===a.length?s="true":(i>2&&"[]"===o.slice(i-2)&&(h=!0,n[o=o.slice(0,i-2)]||(n[o]=[])),s=a[1]?P(a[1]):""),h?n[o].push(s):n[o]=s}return n},O.prototype.recognize=function(t){var e,n=[this.rootState],r={},a=!1,o=t.indexOf("#");-1!==o&&(t=t.substr(0,o));var i=t.indexOf("?");if(-1!==i){var s=t.substr(i+1,t.length);t=t.substr(0,i),r=this.parseQueryString(s)}"/"!==t.charAt(0)&&(t="/"+t);var u=t;O.ENCODE_AND_DECODE_PATH_SEGMENTS?t=h(t):(t=decodeURI(t),u=decodeURI(u));var c=t.length;c>1&&"/"===t.charAt(c-1)&&(t=t.substr(0,c-1),u=u.substr(0,u.length-1),a=!0);for(var l=0;l<t.length&&(n=R(n,t.charCodeAt(l))).length;l++);for(var d=[],f=0;f<n.length;f++)n[f].handlers&&d.push(n[f]);n=d.sort(function(t,e){var n=t.types||[0,0,0],r=n[0],a=n[1],o=n[2],i=e.types||[0,0,0],h=i[0],s=i[1],u=i[2];if(o!==u)return o-u;if(o){if(r!==h)return h-r;if(a!==s)return s-a}return a!==s?a-s:r!==h?h-r:0});var p=d[0];return p&&p.handlers&&(a&&p.pattern&&"(.+)$"===p.pattern.slice(-5)&&(u+="/"),e=function(t,e,n){var r=t.handlers,a=t.regex();if(!a||!r)throw new Error("state not initialized");var o=e.match(a),i=1,h=new x(n);h.length=r.length;for(var s=0;s<r.length;s++){var u=r[s],c=u.names,l=u.shouldDecodes,d=w,f=!1;if(c!==E&&l!==E)for(var p=0;p<c.length;p++){f=!0;var v=c[p],g=o&&o[i++];d===w&&(d={}),O.ENCODE_AND_DECODE_PATH_SEGMENTS&&l[p]?d[v]=g&&decodeURIComponent(g):d[v]=g}h[s]={handler:u.handler,params:d,isDynamic:f}}return h}(p,u,r)),e},O.VERSION="0.3.3",O.ENCODE_AND_DECODE_PATH_SEGMENTS=!0,O.Normalizer={normalizeSegment:u,normalizePath:h,encodePathSegment:l},O.prototype.map=function(t,e){var n=new r;t(a("",n,this.delegate)),i([],n,function(t){e?e(this,t):this.add(t)},this)};function _(){return{}}var D=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},z=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),U=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t};function j(t){return"/"===t.charAt(0)}function L(t){return n=t.split("#")[1]||"/","/"!==(e=j(n)?n:"/"+n).slice(-1)?e+"/":e;var e,n}function I(){}function N(t,e,n,r){var a=e.recognize(n.path);if(!a)return null;for(var o=[],i=U({},function(t,e){var n={};return Object.keys(t).forEach(function(e){n[e]=(r=t[e],r.split("?")[0]);var r}),n}(n),{queryParams:a.queryParams}),h=0;h<a.length;h++){var s=a[h],u=s.params,c=t[s.handler],l=c&&c[r],d=U({},i,{params:u});o.push({handler:l,args:d})}return o}function k(t){t.forEach(function(t){var e=t.handler,n=t.args;"function"==typeof e&&e(n)})}function T(t,e){if(!t)return e;var n=t[0].args,r=t.reduce(function(t,e){var n=e.args.params;return U({},t,n)},{});return U({},n,{params:r})}var H=void 0,B=void 0;function q(t){var e=L(t.oldURL),n=L(t.newURL),r={lastPath:e,path:n},a=N(this.handlers,this.recognizer,r,"enter"),o=T(a,r);a?k(a):this.unrecognizedRouteHandler(e,n),this.handleAfterChange(o)}function M(){window.addEventListener("load",function(t){var e=L(t.target.URL),n=N(this.handlers,this.recognizer,{path:e},"enter");n&&k(n);var r=T(n,{path:e});this.handleLoad(t,r)}.bind(this)),window.addEventListener("popstate",function(t){var e=this.currentPath(),n=T(N(this.handlers,this.recognizer,{path:e}),{path:e});this.handlePopState(t,n)}.bind(this)),function(t){if(void 0!==navigator.msMaxTouchPoints){H=window.location.href;var e=setInterval(function(){try{if(B=window.location.href,H===B)return;t.call(window,{type:"hashchange",newURL:B,oldURL:H}),H=B}catch(t){clearInterval(e)}},100)}else window.addEventListener&&window.addEventListener("hashchange",t,!1)}(q.bind(this))}return function(){function t(e){D(this,t);var n={unrecognizedRouteHandler:function(t,e){this.navigate("/")}.bind(this),handleLoad:I,handlePopState:I,navigateState:_,handleBeforeChange:I,handleAfterChange:I,persistState:function(){var t;return(t=window.history).replaceState.apply(t,arguments)}},r=U({},n,e),a=r.unrecognizedRouteHandler,o=r.handleLoad,i=r.handlePopState,h=r.navigateState,s=r.handleBeforeChange,u=r.handleAfterChange,c=r.persistState;this.recognizer=new O,this.handlers={},this.unrecognizedRouteHandler=a,this.handleLoad=o,this.handlePopState=i,this.navigateState=h,this.handleBeforeChange=s,this.handleAfterChange=u,this.persistState=c,M.call(this)}return z(t,[{key:"addHandler",value:function(t,e){this.handlers[t]=e}},{key:"map",value:function(t){this.recognizer.map(t)}},{key:"currentPath",value:function(){return L(window.location.hash.split("?")[0])}},{key:"navigate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.navigateState(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=j(t)?"#"+t:"#"+this.currentPath()+t,a=window.location.hash,o={path:L(a),nextPath:L(r)},i=N(this.handlers,this.recognizer,o,"leave"),h=T(i,o),s=this.handleBeforeChange(h);if(void 0===(u=s)||u){var u;i&&k(i),window.location.hash=r,this.persistState(e,"",r),n.trigger&&a===r&&q.call(this,{type:"hashchange",oldURL:r,newURL:r})}}},{key:"back",value:function(){window.history.back()}},{key:"forward",value:function(){window.history.forward()}},{key:"pop",value:function(){var t=this.currentPath().match(/(.*)(?:\/.+\/?)/);t&&this.navigate(t[1]+"/")}}]),t}()});
