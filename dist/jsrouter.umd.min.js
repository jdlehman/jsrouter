!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.jsrouter=e()}(this,function(){"use strict";function t(){var t=C(null);return t.__=void 0,delete t.__,t}function e(t,n,r){return function(a,o){var i=t+a;if(!o)return new b(i,n,r);o(e(i,n,r))}}function n(t,e,n){for(var r=0,a=0;a<t.length;a++)r+=t[a].path.length;var o={path:e=e.substr(r),handler:n};t.push(o)}function r(t,e,a,o){for(var i=e.routes,h=Object.keys(i),s=0;s<h.length;s++){var u=h[s],c=t.slice();n(c,u,i[u]);var l=e.children[u];l?r(c,l,a,o):a.call(o,c)}}function a(t){return t.split("/").map(o).join("/")}function o(t){return t.length<3||-1===t.indexOf("%")?t:decodeURIComponent(t).replace(R,encodeURIComponent)}function i(t){return encodeURIComponent(t).replace(x,decodeURIComponent)}function h(t,e){if("object"!=typeof t||null===t)throw new Error("You must pass an object as the second argument to `generate`.");if(!_.call(t,e))throw new Error("You must provide param `"+e+"` to `generate`.");var n=t[e],r="string"==typeof n?n:""+n;if(0===r.length)throw new Error("You must provide a param `"+e+"`.");return r}function s(t,e,n){e.length>0&&47===e.charCodeAt(0)&&(e=e.substr(1));for(var r=e.split("/"),a=void 0,i=void 0,h=0;h<r.length;h++){var s=r[h],u=0,c=0;12&(u=2<<(c=""===s?4:58===s.charCodeAt(0)?1:42===s.charCodeAt(0)?2:0))&&(s=s.slice(1),(a=a||[]).push(s),(i=i||[]).push(0!=(4&u))),14&u&&n[c]++,t.push({type:c,value:o(s)})}return{names:a||L,shouldDecodes:i||L}}function u(t,e,n){return t.char===e&&t.negate===n}function c(t,e){return t.negate?t.char!==e&&-1!==t.char:t.char===e||-1===t.char}function l(t,e){for(var n=[],r=0,a=t.length;r<a;r++){var o=t[r];n=n.concat(o.match(e))}return n}function d(t){t=t.replace(/\+/gm,"%20");var e;try{e=decodeURIComponent(t)}catch(t){e=""}return e}function f(){return{}}function p(t){return"/"===t.charAt(0)}function v(t){return function(t){return"/"!==t.slice(-1)?t+"/":t}(function(t){return p(t)?t:"/"+t}(t.split("#")[1]||"/"))}function g(){}function y(t,e,n,r){var a=e.recognize(n.path);if(!a)return null;for(var o=[],i=B({},function(t,e){var n={};return Object.keys(t).forEach(function(e){n[e]=function(t){return t.split("?")[0]}(t[e])}),n}(n),{queryParams:a.queryParams}),h=0;h<a.length;h++){var s=a[h],u=s.params,c=t[s.handler],l=c&&c[r],d=B({},i,{params:u});o.push({handler:l,args:d})}return o}function m(t){t.forEach(function(t){var e=t.handler,n=t.args;"function"==typeof e&&e(n)})}function w(t,e){if(!t)return e;var n=t[0].args,r=t.reduce(function(t,e){var n=e.args.params;return B({},t,n)},{});return B({},n,{params:r})}function E(t){var e=v(t.oldURL),n=v(t.newURL),r={lastPath:e,path:n},a=y(this.handlers,this.recognizer,r,"enter"),o=w(a,r);a?m(a):this.unrecognizedRouteHandler(e,n),this.handleAfterChange(o)}function S(){window.addEventListener("load",function(t){var e=v(t.target.URL),n=y(this.handlers,this.recognizer,{path:e},"enter");n&&m(n);var r=w(n,{path:e});this.handleLoad(t,r)}.bind(this)),window.addEventListener("popstate",function(t){var e=this.currentPath(),n=w(y(this.handlers,this.recognizer,{path:e}),{path:e});this.handlePopState(t,n)}.bind(this)),function(t){if(void 0!==navigator.msMaxTouchPoints){q=window.location.href;var e=setInterval(function(){try{if(M=window.location.href,q===M)return;t.call(window,{type:"hashchange",newURL:M,oldURL:q}),q=M}catch(t){clearInterval(e)}},100)}else window.addEventListener&&window.addEventListener("hashchange",t,!1)}(E.bind(this))}var C=Object.create,b=function(t,e,n){this.path=t,this.matcher=e,this.delegate=n};b.prototype.to=function(t,e){var n=this.delegate;if(n&&n.willAddRoute&&(t=n.willAddRoute(this.matcher.target,t)),this.matcher.add(this.path,t),e){if(0===e.length)throw new Error("You must have an argument in the function passed to `to`");this.matcher.addChild(this.path,t,e,this.delegate)}};var A=function(e){this.routes=t(),this.children=t(),this.target=e};A.prototype.add=function(t,e){this.routes[t]=e},A.prototype.addChild=function(t,n,r,a){var o=new A(n);this.children[t]=o;var i=e(t,o,a);a&&a.contextEntered&&a.contextEntered(n,i),r(i)};var R=/%|\//g,x=/%(?:2(?:4|6|B|C)|3(?:B|D|A)|40)/g,P=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g,O=Array.isArray,_=Object.prototype.hasOwnProperty,D=[];D[0]=function(t,e){for(var n=e,r=t.value,a=0;a<r.length;a++){var o=r.charCodeAt(a);n=n.put(o,!1,!1)}return n},D[1]=function(t,e){return e.put(47,!0,!0)},D[2]=function(t,e){return e.put(-1,!1,!0)},D[4]=function(t,e){return e};var z=[];z[0]=function(t){return t.value.replace(P,"\\$1")},z[1]=function(){return"([^/]+)"},z[2]=function(){return"(.+)"},z[4]=function(){return""};var U=[];U[0]=function(t){return t.value},U[1]=function(t,e){var n=h(e,t.value);return k.ENCODE_AND_DECODE_PATH_SEGMENTS?i(n):n},U[2]=function(t,e){return h(e,t.value)},U[4]=function(){return""};var j=Object.freeze({}),L=Object.freeze([]),I=function(t,e,n,r,a){this.states=t,this.id=e,this.char=n,this.negate=r,this.nextStates=a?e:null,this.pattern="",this._regex=void 0,this.handlers=void 0,this.types=void 0};I.prototype.regex=function(){return this._regex||(this._regex=new RegExp(this.pattern)),this._regex},I.prototype.get=function(t,e){var n=this.nextStates;if(null!==n)if(O(n))for(var r=0;r<n.length;r++){var a=this.states[n[r]];if(u(a,t,e))return a}else{var o=this.states[n];if(u(o,t,e))return o}},I.prototype.put=function(t,e,n){var r;if(r=this.get(t,e))return r;var a=this.states;return r=new I(a,a.length,t,e,n),a[a.length]=r,null==this.nextStates?this.nextStates=r.id:O(this.nextStates)?this.nextStates.push(r.id):this.nextStates=[this.nextStates,r.id],r},I.prototype.match=function(t){var e=this.nextStates;if(!e)return[];var n=[];if(O(e))for(var r=0;r<e.length;r++){var a=this.states[e[r]];c(a,t)&&n.push(a)}else{var o=this.states[e];c(o,t)&&n.push(o)}return n};var N=function(t){this.length=0,this.queryParams=t||{}};N.prototype.splice=Array.prototype.splice,N.prototype.slice=Array.prototype.slice,N.prototype.push=Array.prototype.push;var k=function(){this.names=t();var e=[],n=new I(e,0,-1,!0,!1);e[0]=n,this.states=e,this.rootState=n};k.prototype.add=function(t,e){for(var n=this.rootState,r="^",a=[0,0,0],o=new Array(t.length),i=[],h=!0,u=0,c=0;c<t.length;c++){for(var l=t[c],d=s(i,l.path,a),f=d.names,p=d.shouldDecodes;u<i.length;u++){var v=i[u];4!==v.type&&(h=!1,n=n.put(47,!1,!1),r+="/",n=D[v.type](v,n),r+=z[v.type](v))}o[c]={handler:l.handler,names:f,shouldDecodes:p}}h&&(n=n.put(47,!1,!1),r+="/"),n.handlers=o,n.pattern=r+"$",n.types=a;var g;"object"==typeof e&&null!==e&&e.as&&(g=e.as),g&&(this.names[g]={segments:i,handlers:o})},k.prototype.handlersFor=function(t){var e=this.names[t];if(!e)throw new Error("There is no route named "+t);for(var n=new Array(e.handlers.length),r=0;r<e.handlers.length;r++){var a=e.handlers[r];n[r]=a}return n},k.prototype.hasRoute=function(t){return!!this.names[t]},k.prototype.generate=function(t,e){var n=this.names[t],r="";if(!n)throw new Error("There is no route named "+t);for(var a=n.segments,o=0;o<a.length;o++){var i=a[o];4!==i.type&&(r+="/",r+=U[i.type](i,e))}return"/"!==r.charAt(0)&&(r="/"+r),e&&e.queryParams&&(r+=this.generateQueryString(e.queryParams)),r},k.prototype.generateQueryString=function(t){var e=[],n=Object.keys(t);n.sort();for(var r=0;r<n.length;r++){var a=n[r],o=t[a];if(null!=o){var i=encodeURIComponent(a);if(O(o))for(var h=0;h<o.length;h++){var s=a+"[]="+encodeURIComponent(o[h]);e.push(s)}else i+="="+encodeURIComponent(o),e.push(i)}}return 0===e.length?"":"?"+e.join("&")},k.prototype.parseQueryString=function(t){for(var e=t.split("&"),n={},r=0;r<e.length;r++){var a=e[r].split("="),o=d(a[0]),i=o.length,h=!1,s=void 0;1===a.length?s="true":(i>2&&"[]"===o.slice(i-2)&&(h=!0,n[o=o.slice(0,i-2)]||(n[o]=[])),s=a[1]?d(a[1]):""),h?n[o].push(s):n[o]=s}return n},k.prototype.recognize=function(t){var e,n=[this.rootState],r={},o=!1,i=t.indexOf("#");-1!==i&&(t=t.substr(0,i));var h=t.indexOf("?");if(-1!==h){var s=t.substr(h+1,t.length);t=t.substr(0,h),r=this.parseQueryString(s)}"/"!==t.charAt(0)&&(t="/"+t);var u=t;k.ENCODE_AND_DECODE_PATH_SEGMENTS?t=a(t):(t=decodeURI(t),u=decodeURI(u));var c=t.length;c>1&&"/"===t.charAt(c-1)&&(t=t.substr(0,c-1),u=u.substr(0,u.length-1),o=!0);for(var d=0;d<t.length&&(n=l(n,t.charCodeAt(d))).length;d++);for(var f=[],p=0;p<n.length;p++)n[p].handlers&&f.push(n[p]);n=function(t){return t.sort(function(t,e){var n=t.types||[0,0,0],r=n[0],a=n[1],o=n[2],i=e.types||[0,0,0],h=i[0],s=i[1],u=i[2];if(o!==u)return o-u;if(o){if(r!==h)return h-r;if(a!==s)return s-a}return a!==s?a-s:r!==h?h-r:0})}(f);var v=f[0];return v&&v.handlers&&(o&&v.pattern&&"(.+)$"===v.pattern.slice(-5)&&(u+="/"),e=function(t,e,n){var r=t.handlers,a=t.regex();if(!a||!r)throw new Error("state not initialized");var o=e.match(a),i=1,h=new N(n);h.length=r.length;for(var s=0;s<r.length;s++){var u=r[s],c=u.names,l=u.shouldDecodes,d=j,f=!1;if(c!==L&&l!==L)for(var p=0;p<c.length;p++){f=!0;var v=c[p],g=o&&o[i++];d===j&&(d={}),k.ENCODE_AND_DECODE_PATH_SEGMENTS&&l[p]?d[v]=g&&decodeURIComponent(g):d[v]=g}h[s]={handler:u.handler,params:d,isDynamic:f}}return h}(v,u,r)),e},k.VERSION="0.3.3",k.ENCODE_AND_DECODE_PATH_SEGMENTS=!0,k.Normalizer={normalizeSegment:o,normalizePath:a,encodePathSegment:i},k.prototype.map=function(t,n){var a=new A;t(e("",a,this.delegate)),r([],a,function(t){n?n(this,t):this.add(t)},this)};var T=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},H=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),B=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},q=void 0,M=void 0;return function(){function t(e){T(this,t);var n={unrecognizedRouteHandler:function(t,e){this.navigate("/")}.bind(this),handleLoad:g,handlePopState:g,navigateState:f,handleBeforeChange:g,handleAfterChange:g,persistState:function(){var t;return(t=window.history).replaceState.apply(t,arguments)}},r=B({},n,e),a=r.unrecognizedRouteHandler,o=r.handleLoad,i=r.handlePopState,h=r.navigateState,s=r.handleBeforeChange,u=r.handleAfterChange,c=r.persistState;this.recognizer=new k,this.handlers={},this.unrecognizedRouteHandler=a,this.handleLoad=o,this.handlePopState=i,this.navigateState=h,this.handleBeforeChange=s,this.handleAfterChange=u,this.persistState=c,S.call(this)}return H(t,[{key:"addHandler",value:function(t,e){this.handlers[t]=e}},{key:"map",value:function(t){this.recognizer.map(t)}},{key:"currentPath",value:function(){return v(window.location.hash.split("?")[0])}},{key:"navigate",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.navigateState(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=p(t)?"#"+t:"#"+this.currentPath()+t,a=window.location.hash,o={path:v(a),nextPath:v(r)},i=y(this.handlers,this.recognizer,o,"leave"),h=w(i,o);(function(t){return void 0!==t&&!t})(this.handleBeforeChange(h))||(i&&m(i),window.location.hash=r,this.persistState(e,"",r),n.trigger&&a===r&&E.call(this,{type:"hashchange",oldURL:r,newURL:r}))}},{key:"back",value:function(){window.history.back()}},{key:"forward",value:function(){window.history.forward()}},{key:"pop",value:function(){var t=this.currentPath().match(/(.*)(?:\/.+\/?)/);t&&this.navigate(t[1]+"/")}}]),t}()});
